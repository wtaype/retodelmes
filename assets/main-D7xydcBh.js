import{$ as a,g as f,d as u,a as n,w as g,b as F,q as A,c as R,e as D,f as I,h as E,u as M,s as z,i as C,j as k,k as G,M as l,l as m,m as L,n as P,o as S,p as V,r as B}from"./widev-9nBR2YtD.js";a(".toggle-password").click(function(e){e.preventDefault();const s=a(this),o=s.data("target"),i=a("#"+o),r=s.find("i");i.attr("type",(t,c)=>c==="password"?"text":"password").focus(),r.toggleClass("fa-eye fa-eye-slash")});const p=(e,s)=>{a(e).removeClass("active").addClass("hidden"),a(s).removeClass("hidden").addClass("active")};a(".olvidastePass").click(e=>{e.preventDefault(),p(".login-form",".recovery-form")});a(document).on("click",".crearCuenta",e=>{e.preventDefault(),p(".login-form",".upd-form")});a(".volverLogin").click(e=>{e.preventDefault(),p(".recovery-form",".login-form")});a(".conCuenta").click(e=>{e.preventDefault(),p(".upd-form",".login-form")});let d="smiles",O=3e3,U="wiAuthIn",T="wiAuthRol",v="smile",y="Cielo";(async function(){try{(await f(u(n,"smilesTop","configuracion"))).data()?.crearCuenta&&a(".form-footer").append('<a href="#" class="crearCuenta">Crear cuenta</a>')}catch{}})();a(".togglePass").click(function(){const e=a(this).siblings("input"),s=e.attr("type")==="password";e.attr("type",s?"text":"password"),a(this).toggleClass("fa-eye fa-eye-slash")});a('.miauth input:not([type="checkbox"])').on("click",function(){g(this,a(this).attr("placeholder"))});a("#regUsuario, #regEmail, #email, #recEmail").on("input",function(){a(this).val(a(this).val().toLowerCase().trim())});[["#password","#Login"],["#regPassword1","#Registrar"],["#recFechaNacimiento","#Recuperar"],["#recEmail","#Recuperar"]].forEach(([e,s])=>{a(e).on("input keyup",o=>{a(s).removeClass("inactivo"),o.key==="Enter"&&(a(s).click(),a(s).addClass("inactivo"))})});const q={regEmail:[e=>e.toLowerCase(),e=>/^[\w-]+(\.[\w-]+)*@([\w-]+\.)+[a-zA-Z]{2,7}$/.test(e)||"Correo inválido"],regUsuario:[e=>e.toLowerCase().replace(/[^a-z0-9_]/g,""),e=>e.length>=3||"Usuario 3-20 caracteres"],regNombre:[e=>e.trim(),e=>e.length>0||"Ingrese nombre"],regApellidos:[e=>e.trim(),e=>e.length>0||"Ingrese apellidos"],regGenero:[e=>e,e=>["femenino","masculino"].includes(e)||"Selecciona género"],regFechaNacimiento:[e=>e,e=>B(e)>=13||"Tienes que ser mayor de 13 años"],regPassword:[e=>e,e=>e.length>=6||"Mínimo 6 caracteres"],regPassword1:[e=>e,e=>e===a("#regPassword").val()||"Contraseñas no coinciden"]};a.each(q,function(e,[s,o]){a(`#${e}`).on("blur change",function(){const i=s(a(this).val());a(this).val(i);const r=o(i);r!==!0&&g(this,r,"error")})});let x=!1;a("#regUsuario").on("blur focus",async function(){const e=a(this).val();if(e.length>=3)try{const o=(await f(u(n,d,e))).exists();x=!o,g(this,`Usuario ${o?"no disponible":'disponible <i class="fa-solid fa-circle-check"></i>'}`,o?"error":"success","top",7e3)}catch(s){console.error(s)}});let N=!1;a("#regEmail").on("blur focus",async function(){const e=a(this).val();if(e.length>=3)try{const o=!(await F(A(R(n,d),D("email","==",e)))).empty;N=!o,g(this,`Email ${o?"no disponible":'disponible <i class="fa-solid fa-circle-check"></i>'}`,o?"error":"success","top",7e3)}catch(s){console.error(s)}});a("#Registrar").click(async function(){const e=[[x,a("#regUsuario")[0],"Usuario no disponible"],[N,a("#regEmail")[0],"Email no disponible"],...Object.entries(q).map(([s,[o,i]])=>{const r=a(`#${s}`),t=o(r.val()),c=i(t);return[c===!0,r[0],c!==!0?c:""]})];for(const[s,o,i]of e)if(!s&&i&&(g(o,i,"error"),o.focus(),!0))return;try{const s=["regEmail","regUsuario","regNombre","regApellidos","regGenero","regPassword"],[o,i,r,t,c,h]=s.map(j=>a("#"+j).val().trim()),b={masculino:["Cielo|#0EBEFF","Paz|#29C72E"],femenino:["Dulce|#FF5C69","Mora|#7000FF"]}[c]||["Paz|#29C72E","Cielo|#0EBEFF"];y=b[Math.floor(Math.random()*b.length)];const{user:w}=await I(E,o,h);await Promise.all([M(w,{displayName:i}),z(w)]),console.log('Registro completo en Auth <i class="fa-solid fa-circle-check"></i>'+Date());const $=u(n,d,i);await C($,{usuario:i,email:o,nombre:r,apellidos:t,genero:c,rol:v,fechaNacimiento:G(a("#regFechaNacimiento").val()),creacion:k(),participa:"si",imagen:"",descripcion:"",uid:w.uid}),await C(u(n,"preferencias",i),{usuario:i,email:o,wiTema:y,fechaActualizacion:k()}),console.log('Registro completo en Firestore <i class="fa-solid fa-circle-check"></i>'+Date()),l('Registro completado! <i class="fa-solid fa-circle-check"></i>')}catch(s){l({"auth/email-already-in-use":"Email ya registrado","auth/weak-password":"Contraseña muy débil"}[s.code]||s.message)||console.error(s)}finally{m(U,"wIn",24),m(T,v,24),m("wiTema",y,72),setTimeout(()=>L(v),O)}});a("#Login").click(async function(){P(!0);try{const[e,s]=["#email","#password"].map(h=>a(h).val()),o=e.includes("@"),i=o?null:await f(u(n,d,e));if(!o&&!i.exists())throw new Error("Usuario no encontrado");const r=o?e:i.data().email;await S(E,r,s);const t=!o&&(await f(u(n,"preferencias",e)))?.data?.()?.wiTema||null,c=i?.data()?.rol||"smile";L(c),m(U,"wIn",24),m(T,c,24),t&&m("wiTema",t,72)}catch(e){l({"auth/invalid-credential":"Contraseña incorrecta","auth/invalid-email":"Falta registrar Email","auth/missing-email":"Email o usuario no registrado"}[e.code]||e.message,"error"),console.error(e)}finally{P(!1)}});a("#Recuperar").click(async function(){try{const[e,s]=["#recEmail","#recFechaNacimiento"].map(t=>a(t).val()),o=e.includes("@")?e:await(async()=>{const t=await f(u(n,d,e));return t.exists()?t.data().email:null})();if(!o)return l("Usuario no registrado","error");const i=await F(A(R(n,d),D("email","==",o)));if(i.empty)return l("Email incorrecto o no existe","error");if(i.docs[0].data().fechaNacimiento.toDate().toISOString().split("T")[0]!==s)return l("Fecha de nacimiento incorrecta","error");await V(E,o),l('Se envió correo para restablecer su contraseña, revisa en principal o spam <i class="fa-solid fa-circle-check"></i>',"success")}catch(e){console.error(e)}});
